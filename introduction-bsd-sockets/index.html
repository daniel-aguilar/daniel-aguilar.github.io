<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Introduction to BSD Sockets | Daniel’s Blog</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Introduction to BSD Sockets" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The operating system truly makes developers’ jobs much more easier: we don’t have to worry about the boring details, and can focus on what our programs do instead. Keeping with the same philosophy of abstracting the details, and thanks to the people at UC Berkeley, communicating over a network isn’t that much different as writing some data to a file." />
<meta property="og:description" content="The operating system truly makes developers’ jobs much more easier: we don’t have to worry about the boring details, and can focus on what our programs do instead. Keeping with the same philosophy of abstracting the details, and thanks to the people at UC Berkeley, communicating over a network isn’t that much different as writing some data to a file." />
<meta property="og:site_name" content="Daniel’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-06T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Introduction to BSD Sockets" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-07-06T00:00:00+00:00","datePublished":"2020-07-06T00:00:00+00:00","description":"The operating system truly makes developers’ jobs much more easier: we don’t have to worry about the boring details, and can focus on what our programs do instead. Keeping with the same philosophy of abstracting the details, and thanks to the people at UC Berkeley, communicating over a network isn’t that much different as writing some data to a file.","headline":"Introduction to BSD Sockets","mainEntityOfPage":{"@type":"WebPage","@id":"/introduction-bsd-sockets/"},"url":"/introduction-bsd-sockets/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Daniel&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Daniel&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Introduction to BSD Sockets</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-07-06T00:00:00+00:00" itemprop="datePublished">Jul 6, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The operating system truly makes developers’ jobs much more easier: we don’t
have to worry about the boring details, and can focus on what our programs do
instead. Keeping with the same philosophy of abstracting the details, and thanks
to the people at UC Berkeley, communicating over a network isn’t that much
different as writing some data to a file.</p>

<p>The example I’ll be working on will be the classic client-server model, using
IPv4. The server will be listening for messages (printing them out as they come)
and react accordingly, while the client sends messages and outputs responses
from the server. The server runs in a Docker container in its own network. You
can find the example <a href="https://github.com/daniel-aguilar/daniel-aguilar.github.io/tree/master/samples/bsd-sockets">here</a>.</p>

<p>The example is written in C. Most modern programming languages provide support
for (the now called low-level) sockets, but what better way to learn other than
using the original implementation?</p>

<h2 id="the-basics">The Basics</h2>

<p>The original implementation of the TCP/IP stack for Unix-like systems appeared
in 4.2BSD, it was later adopted as a POSIX standard. As I mentioned, it was
written in C, and introduced the concept of the socket—an endpoint for
communication between processes.</p>

<p>There are many <em>domains</em> of sockets (also known as <em>families</em>), but the 2 most
popular you’ll encounter are <em>UNIX domains</em> and <em>Internet protocols</em>. While I’ll
be discussing the Internet protocols family of sockets in this article, UNIX
domain sockets are not that different. They’re used for efficient local
communication (on the same machine). The Docker daemon, for instance, uses this
type of socket.</p>

<p>Sockets also have <em>types</em>. I’ll be working with stream-type sockets
(<code class="language-plaintext highlighter-rouge">SOCK_STREAM</code>), corresponding to a TCP socket.</p>

<h3 id="the-telephone-analogy">The Telephone Analogy</h3>

<p>A well-known way of explaining sockets is using the telephone analogy. In order
to receive a call, you must first install a phone, have a phone number, hear it
ring, and finally take the call. Generally, you do not need to know the caller’s
number.</p>

<p>To make a phone call, the process is somewhat the same in that you still need a
phone, but instead of passively listen for incoming calls, you dial a number
instead, and wait for someone to answer.</p>

<p>Sockets work like telephones. On the server side, you create a <code class="language-plaintext highlighter-rouge">socket()</code>,
<code class="language-plaintext highlighter-rouge">bind()</code> a local address to it, <code class="language-plaintext highlighter-rouge">listen()</code> for connections, and finally
<code class="language-plaintext highlighter-rouge">accept()</code> one. On the client side, you create a <code class="language-plaintext highlighter-rouge">socket()</code> and <code class="language-plaintext highlighter-rouge">connect()</code> to
an address.</p>

<h2 id="working-with-addresses">Working with Addresses</h2>

<p>While we can work with dot-decimal notation IP addresses (e.g. 192.168.1.110),
ultimately they have to be converted to binary form (network byte order). Both
<code class="language-plaintext highlighter-rouge">bind()</code> and <code class="language-plaintext highlighter-rouge">connect()</code> have a <code class="language-plaintext highlighter-rouge">sockaddr</code> argument, a struct that holds data
about an address. You will see something like this in the client and server
code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">in_addr</span> <span class="n">ip</span><span class="p">;</span>

<span class="n">inet_aton</span><span class="p">(</span><span class="s">"192.168.1.110"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
<span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
<span class="n">address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
<span class="n">address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span></code></pre></figure>

<p>We can use the <code class="language-plaintext highlighter-rouge">inet_aton()</code> and <code class="language-plaintext highlighter-rouge">htons()</code> utilities to convert such
values. Finally, we need to specify what kind of address we’re talking
about. The address family for IPv4 Internet protocols is <code class="language-plaintext highlighter-rouge">AF_INET</code>.</p>

<h2 id="server-code">Server Code</h2>

<p>This server will implement a simple protocol consisting of two commands: <code class="language-plaintext highlighter-rouge">HELLO</code>
and <code class="language-plaintext highlighter-rouge">BYE</code>. If the client sends a <code class="language-plaintext highlighter-rouge">HELLO</code> message, the server then replies with
“HI”, while a <code class="language-plaintext highlighter-rouge">BYE</code> message instructs the server to shut down. All messages
received must be sent to stdout.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="c1">// server.c stub</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">data_socket</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">conn_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">bind</span><span class="p">(</span><span class="n">conn_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span>
     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
<span class="n">listen</span><span class="p">(</span><span class="n">conn_socket</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
	<span class="n">data_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">conn_socket</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">read</span><span class="p">(</span><span class="n">data_socket</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
	<span class="n">puts</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"HELLO"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"HI</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">write</span><span class="p">(</span><span class="n">data_socket</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">data_socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"BYE"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">close</span><span class="p">(</span><span class="n">conn_socket</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Assuming <code class="language-plaintext highlighter-rouge">address</code> has been correctly assigned, line 4 creates an IPv4
<em>listening</em> socket. I say listening because once we accept a connection, a new
socket is created, so as to support multiple concurrent connections. Line 5
binds the previous socket to an address, while line 7 configures the socket to
listen for up to 5 pending connections in a queue.</p>

<p>The main loop consists of accepting a new connection, reading 12 bytes from the
socket, implement a HELLO protocol, and then close the data socket. If a <code class="language-plaintext highlighter-rouge">BYE</code>
command is received, the listening socket is closed too.</p>

<p>If you’ve worked with file I/O in C before, you’ll notice the process is
essentially the same. <code class="language-plaintext highlighter-rouge">data_socket</code> is a file descriptor and so the standard
<code class="language-plaintext highlighter-rouge">read()</code> and <code class="language-plaintext highlighter-rouge">write()</code> operations work as they would with any other file.</p>

<h2 id="client-code">Client Code</h2>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// client.c stub</span>
<span class="kt">char</span> <span class="n">response</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span>
        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>

<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">"HELLO"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span></code></pre></figure>

<p>The client can be significantly smaller as it only has one task. Again, here I’m
assuming <code class="language-plaintext highlighter-rouge">address</code> its been properly assigned. In this particular instance I am
expected to received a “HI” response from the server.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this explanation was clear. I tried to keep the code concise by removing
includes, error handling noise and other off topic details, but I encourage you
to download the <a href="https://github.com/daniel-aguilar/daniel-aguilar.github.io/tree/master/samples/bsd-sockets">full example</a> and try it yourself.</p>


  </div><a class="u-url" href="/introduction-bsd-sockets/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Daniel&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <p>There will be code</p>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/daniel-aguilar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">daniel-aguilar</span></a></li><li><a href="https://www.linkedin.com/in/dan-aguilar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">dan-aguilar</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>RSS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>
          This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a><img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em;">
        </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
